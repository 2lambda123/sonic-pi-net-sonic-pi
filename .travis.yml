language: ruby

os: linux
sudo: required

matrix:
    include:
        - dist: trusty
        - dist: xenial

addons:
  apt:
    update: true
    sources:
      - sourceline: 'ppa:latthias/qgis-travis-deps'
    packages:
    - ruby-all-dev
    - rake
    - cmake
    - pkg-config
    - g++
    - libfftw3-dev
    - libffi-dev
    - libqt5scintilla2-dev
    - qtbase5-dev
    - qttools5-dev
    - qttools5-dev-tools
    - qt5-default
    - libqt5opengl5-dev
    - libqt5svg5-dev
    - libqwt-qt5-dev
    - libboost-all-dev
    - libasound2-dev
    - erlang

compiler: gcc

cache:
 - apt
 - ccache

rvm:
  # (See https://www.ruby-lang.org/en/downloads/branches/ and https://www.ruby-lang.org/en/downloads/branches/ for release info)
  # Security maintenance phase
  - 2.4
  # Maintained releases
  - 2.5
  - 2.6
  - 2.7

before_install:
  - |
    set -e # Fail on error
    # Build and install aubio 0.4.4
    wget http://aubio.org/pub/aubio-0.4.4.tar.bz2
    tar xvjf aubio-0.4.4.tar.bz2
    cd aubio-0.4.4
    ./waf configure build
    sudo ./waf install

    # Force update RubyGems to avoid issues with Bundler Gemfile 'BUNDLED_WITH' versions
    yes | gem update --system --force
    # Install extra gems needed for build
    gem install bundler kramdown # (Bundler 2 is used)
    gem install gettext -v 3.2.9 # Last version that works with Ruby 2.4

script:
 - set -e
# the | starts a multiline YAML entry
 - |
    echo ""
    echo "***********************************"
    echo "* Building the Sonic Pi Server    *"
    echo "***********************************"
    cd $TRAVIS_BUILD_DIR
    rake server:build

    echo ""
    echo "***********************************"
    echo "* Running the Sonic Pi test suite *"
    echo "***********************************"
    rake server:test
